#!/bin/bash

I3B_OPERA_DL_URL="https://download3.operacdn.com/pub/opera/desktop/62.0.3331.66/linux/opera-stable_62.0.3331.66_amd64.deb"
I3B_MICROSOFT_DL_URL="https://packages.microsoft.com/config/ubuntu/19.04/packages-microsoft-prod.deb"
I3B_YED_DL_URL="https://www.yworks.com/resources/yed/demo/yEd-3.19_with-JRE11_64-bit_setup.sh"
I3B_CHROME_DL_URL="https://dl.google.com/linux/direct/google-chrome-stable_current_amd64.deb"
I3B_SLMENU_REPO_URL="https://bitbucket.org/rafaelgg/slmenu"
I3B_SENT_REPO_URL="https://github.com/chrissxYT/sane-sent"

isnap() (snap install $@)
iapt()  (apt install -y $@)
udpkg() (tools/udpkg $@)

source i3brc

###### Update packages and add ppas
udpkg $I3B_MICROSOFT_DL_URL
dpkg --add-architecture i386
apt-key adv --keyserver keyserver.ubuntu.com --recv-keys 3FA7E0328081BFF6A14DA29AA6A19B38D3D831EF
for p in $(cat packages/aku) ; do curl -fsSL $p | apt-key add - ; done
apt-key adv --keyserver keyserver.ubuntu.com --recv-keys 76F1A20FF987672F
rm -rf /etc/apt/sources.list.d
cp -f configs/sources.list /etc/apt/sources.list
apt update
apt upgrade -y

###### Install main apps, drivers and dependencies
echo ttf-mscorefonts-installer msttcorefonts/accepted-mscorefonts-eula select true | debconf-set-selections
iapt gcc g++ clang make
[ "$I3B_VSCODE" = 1 ] && isnap vscode --classic
isnap github-desktop --beta --classic
cp -f configs/env /etc/environment
for p in $(cat packages/apt) ; do apt install -y $p ; done
for p in $(cat packages/pip) ; do pip install $p ; done
packages/netsh
for p in $(cat packages/udpkg) ; do udpkg $p ; done
[ "$I3B_BROWSER" = b ] && iapt brave-browser
[ "$I3B_BROWSER" = o ] && udpkg $I3B_OPERA_DL_URL
[ "$I3B_BROWSER" = f ] && iapt firefox
[ "$I3B_BROWSER" = c ] && udpkg $I3B_CHROME_DL_URL
# just to make sure icons arent corrupted all the time (happend on my machine)
apt remove -y breeze-cursor-theme

###### Install slmenu
netsh -s hg -C "make install" -c $I3B_SLMENU_REPO_URL

###### Get and install yEd
###### (yes, netsh can be used for this, because it is a shell script)
[ "$I3B_YED" = 1 ] && netsh $I3B_YED_DL_URL

###### Get and install sane-sent
netsh -C "make install" -c $I3B_SENT_REPO_URL

###### Get and install the Arduino IDE
if [ "$I3B_ARDUINO" = 1 ] ; then
	curl https://downloads.arduino.cc/arduino-1.8.8-linux64.tar.xz |\
                tar xJf -
	mv arduino-1.8.8 /usr/bin/
        pushd .
	cd /usr/bin/arduino-1.8.8
        ./arduino-linux-setup.sh $(logname)
        popd
fi

if [ "$I3B_TEENSY" = 1 ] ; then
	###### Get and install the Teensy loader
	curl -o /etc/udev/rules.d/49-teensy.rules https://www.pjrc.com/teensy/49-teensy.rules
	curl https://www.pjrc.com/teensy/teensy_linux64.tar.gz | \
                tar xzf -
	mv -f teensy /usr/bin
	rm -f libpng12.so.0 libusb-0.1.so.4

        [ "$I3B_ARDUINO" = 1 ] && netsh https://www.pjrc.com/teensy/td_145/TeensyduinoInstall.linux64
fi

###### Get and install TeamViewer
[ "$I3B_TEAMVIEWER" = 1 ] && udpkg https://download.teamviewer.com/download/linux/teamviewer_amd64.deb

###### Get and install FlashPrint
[ "$I3B_FLASHPRINT" = 1 ] && udpkg http://www.sz3dp.com/upfile/2018/12/03/20181203162713_662.deb

###### Build git libsecret cred helper
pushd .
cd /usr/share/doc/git/contrib/credential/gnome-keyring
make
popd

###### Get and install EOS
if [ "$I3B_EOS" = 1 ] ; then
	mkdir tmp_eos_stuff
	cd tmp_eos_stuff
	curl -L -o eos.zip https://www.pabst-software.de/lib/exe/fetch.php?media=programme:eos:eos.zip
	unzip eos.zip
	cp -f EOS.exe /usr/bin/eos.exe
	cd ..
	rm -rf tmp_eos_stuff
        cp -f tools/eos /usr/bin/eos
fi

###### Install tools
cd tools
make install clean
cd ..

###### Change the distro name
cp -f configs/issue /etc/issue
cp -f configs/issue.net /etc/issue.net
cp -f configs/os-release /etc/os-release
cp -f configs/lsbr /etc/lsb-release

###### Finish up everything
apt -f install -y
apt autoremove -y

###### install the chrissx Media NAS
[ "$I3B_CM_NAS" = 1 ] && cat configs/cm_nas >> /etc/fstab

# give the user rights to all of their home directory
chown -R $(logname):$(logname) ~

# change the login shell to zsh
# (have to do this here, so you dont have to put in your pw again)
chsh -s /bin/zsh $(logname)
